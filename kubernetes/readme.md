# Kubernetes
## Projects
- Hello World REST API
- 2 Microservices - Currency Exchange and Currency Conversion
    
## Steps
- Step 01 - Getting Started with Docker, Kubernetes and Google Kubernetes Engine    
run an application on kubernets: 
  
    kubectl create deployment hello-world-rest-api --image=in28min/hello-world-rest-api:0.0.1.RELEASE
    kubectl expose deployment hello-world-rest-api --type=LoadBalancer --port=8080
   
creating multiple instances: 
  
     kubectl scale deployment herllo-wordl-rest=api -- replicas=3
     
deleting an instance: 
  
    kubectl delete pod hello-world-rest-api-"SHA"
    
kubernets keep 3 instance running even one down, recriating another and keep app online all the time

controling resources for an instance based on the load: 

    kubectl autoscale deployment hello-wordl=rest-api --max=10 --cpu-percent=70
    
configuring a new release in X seconds without downtime:
    
    kubectl edit deployment hello-world-rest-api
insert line:

    specs:
    ...
    minReadySeconds: 20
    ...
    
starting the new release :
    
    kubectl set image deployment hello-world-rest-api --image=in28min/hello-world-rest-api:0.0.2.RELEASE
    
The release will be changed after some feel seconds (20s)
  
- Step 02 - Creating Google/Oracle/Azure/AWS Cloud Account
  Cluster is a combinations of nodes
  Manage cluster: master nodes
  Run aplications/serviÃ§os: worker nodes
  
- Step 03 - Creating Kubernetes Cluster with Oracle Cloud Kubernete Engine
  Create an standard cluster on any cloud porvider
  
- Step 04 - Review Kubernetes Cluster and Learn Few Fun Facts about Kubernetes
Conect to kubernets using cloud shell and create a kubectl config using cloud shell terminal (it depends of the cluster created)
  
    oci ce cluster create-kubeconfig --cluster-id ocid1.cluster.oc1.sa-saopaulo-1.aaaaaaaaae2timzvgmywinzwmq4gmnjthbqwknlfgzrdqzjqgc4wmnjtmizd --file $HOME/.kube/config --       region sa-saopaulo-1 --token-version 2.0.0 
    
    kubectl version
  
 Oracle cloud shell documentation: 
    
    https://docs.cloud.oracle.com/en-us/iaas/Content/API/Concepts/cloudshellintro.htm  
    
- Step 05 - Deploy Your First Spring Boot Application to Kubernetes Cluster
deploy an API from docker hub repository:

    kubectl create deployment hello-world-rest-api --image=in28min/hello-world-rest-api:1.0.0.RELEASE
    
expose to the outside attached in a load balancer:
    
    kubectl expose deployment hello-world-rest-api --type=LoadBalancer --port=8080 
    
list deployments:
    
    kubectl get deployments

confirm address using: 

    kubectl get pods -o wide
      
- Step 06 - Quick Look at Kubernetes Concepts - Pods, Replica Sets and Deployment
Running pods information:    
    
    kubectl get pods
    kubectl get pod
    kubectl get service
    kubectl get deployment
    
 Container Orchestration > manages more them 1000 instances with 1000 microservices...
 Features > Declarative, easy scalling, load balancing, self healing, zero downtime.
 Cloud neural > Standardized PLataform on any Infrastructure
    
- Step 07 - Understanding Pods in Kubernetes
PODs are the deployments unit in kubernets, so there is no container  withou a po
Detailed pod info:

    kubectl get pods -o wide
    
A pod has an IP and can include more then one containers
Explanation about pod:

  kubectl explain pods

Detailed of a pod

    kubectl describe pod "POD_NAME"]
    
PS: It is recomended to dele an cluster that are no in use
Show replications:
    
    kubectl get replicasets
    
Continues UP pods:
    
    kubectl get pods -o wide
    kubectl delete pods "POD_NAME"
    kubectl get pods -o wide
    
Configure number of replicas:
    
    kubectl scale deployment nginx --replicas=3
    
Check internal log:
    
    kubectl get events
    
Sorted mode:

    kubectl get events --sort-by=.metada.creationTimestamp
    
Explanations:

    kubectl explain replicaset
    
- Step 08 - Understanding ReplicaSets in Kubernetes
Zero Downtime

replicaset information: 
    
    kubectl get rs
    kubectl get rs -o wide
    
DUNNY_IMAGES do not afects the current runing pods

- Step 09 - Understanding Deployment in Kubernetes
conainers inside pods

- Step 10 - Quick Review of Kubernetes Concepts - Pods, Replica Sets and Deployment
pods inside replica sets
replicasets ensure a number of pods is always running, no downtime
    
- Step 11 - Understanding Services in Kubernetes]
The internal ip address is diferent for pods generated by replication set
The external IP keep the sames
The external is the same because it is associated wiyh the service by the load balance (network services)

List cluster services:
    
    kubectl get services
    
in load balance network configurations you can see the nodes associated as well.    

- Step 12 - Quick Review of GKE on Google Cloud Console 

- Step 13 - Understanding Kubernetes Architecture - Master Node and Nodes
    The most importante cmponents running on the MASTER NODE are:
    API Server - Distribute DB - Scheduler - Controller Manager
Responsables:
    kube-apiserver
    etcd
    kube-scheduler
    kube-controller-manager
    
The most importante cmponents running on WORKER NODE are:
Node Agent - Networking Componenet - Container Runtime - PODS    
Responsables:
    kubelet
    kube-proxy
    CRI - docker,rkt
    Multiple pods runing (containers)
    
Master node manages cluster
Worker nodes run your aplication

Check ststaus of componenets envolved in master nod:

    kubectl get componentstatuses

- Step 14 - Understand Google Cloud Regions and Zones
    Regions is directly related to latency
    Replicas in diferetnt regions can bring more security
    In one region also has diferetn zones (datacenters)
    
- Step 15 - Installing GCloud/Oracle CLI
    
    Intaling "GCloud" on linux, mac or windows https://cloud.google.com/sdk/docs/install
    
    Intaling "OCLI" on linux, mac or windows https://www.oracle.com/br/technical-resources/articles/cloudcomp/utilizando-oci-cli-p1.html
    
    For OCLI you need to paste generated public key on console at USER_SETTINGS > API KEYS.
    
- Step 16 - Installing Kubectl 

kubectl instalation https://kubernetes.io/docs/tasks/tools/install-kubectl/
Check version:
    
    kubectl version
    
Use it in local machine.
    
- Step 17 - Understand Kubernetes Rollouts

List rollout history available:
    
    kubectl rollout history deployment nginx

Including a rollout image:

    kubectl set image deployment nginx nginx=example/nginx:0.0.1.RELEASE --record=true
    
Returning to a previous one:    
       
    kubectl rollout undo deployment nginx --to-revision=1
    
It is possible to do a pos or previous deployment rollout.

Check logs:
    
    get logs "POD_SHA"
    
- Step 18 - Generate Kubernetes YAML Configuration for Deployment and Service
Kubernets is declarative, and can be used an YAML file

Show yaml respective file from running deployment:

    kubectl get deployment nginx -o yaml
    
Export an yaml respective file from running service:    

    kubectl get service nginx -o yaml > service.yaml

Exported yaml file can be opened in VS code or any text editor

Applying changes using an yaml file:
    
    kubectl apply -f service.yaml
    
Creating PODS from begi using a simple yaml file:

    apiVersion: extensions/v1beta1
    kind: Deployment
    metadata:
      labels:
        app: hello-world-rest-api
      name: hello-world-rest-api
      namespace: default
    spec:
      replicas: 2
      selector:
        matchLabels:
          app: hello-world-rest-api
      strategy:
        rollingUpdate:
          maxSurge: 25%
          maxUnavailable: 25%
        type: RollingUpdate
      template:
        metadata:
          labels:
            app: hello-world-rest-api
        spec:
          containers:
          - image: in28min/hello-world-rest-api:0.0.1.RELEASE
            imagePullPolicy: IfNotPresent
            name: hello-world-rest-api
          restartPolicy: Always
          terminationGracePeriodSeconds: 30
    ---
    apiVersion: v1
    kind: Service
    metadata:
      labels:
        app: hello-world-rest-api
      name: hello-world-rest-api
      namespace: default
    spec:
      ports:
      - nodePort: 32208
        port: 8080
        protocol: TCP
        targetPort: 8080
      selector:
        app: hello-world-rest-api
      sessionAffinity: None
      type: LoadBalancer
      
List all deployments to get similar label (SELECTOR):

    kubectl get all -o wide

Removing all deployments and services using label:
    
    kubectl delete all -l "LABEL"

Creating from yaml file:
    
    kubectl apply -f "xxx.yaml"
    
Watch and access the new environment created using an yaml file:

    kubectl svc --watch
    
Check/Apply only the difference (update parameters) from a same service yaml:
    
    kubectl diff -f "xxx.yaml"
    kubectl apply -f "xxx.yaml"

- Step 19 - Understand and Improve Kubernetes YAML Configuration
    

- Step 20 - Using Kubernetes YAML Configuration to Create Resources
- Step 21 - Understanding Kubernetes YAML Configuration - Labels and Selectors
- Step 22 - Quick Fix to reduce release downtime with minReadySeconds
- Step 23 - Understanding Replica Sets in Depth - Using Kubernetes YAML Config
- Step 24 - Configure Multiple Kubernetes Deployments with One Service
- Step 25 - Playing with Kubernetes Commands - Top Node and Pod
- Step 26 - Delete Hello World Deployments
- Step 27 - Quick Introduction to Microservices - CE and CC
- Step 28 - Deploy Microservices to Kubernetes
- Step 29 - Understand Environment Variables created by Kubernetes for Services
- Step 30 - Microservices and Kubernetes Service Discovery - Part 1
- Step 31 - Microservices and Kubernetes Service Discovery - Part 2 DNS
- Step 32 - Microservices Centralized Configuration with Kubernetes ConfigMaps
- Step 33 - Simplify Microservices with Kubernetes Ingress - Part 1
- Step 34 - Simplify Microservices with Kubernetes Ingress - Part 2
- Step 35 - Delete Kubernetes Clusters


## Commands

```
docker run -p 8080:8080 in28min/hello-world-rest-api:0.0.1.RELEASE

kubectl create deployment hello-world-rest-api --image=in28min/hello-world-rest-api:0.0.1.RELEASE
kubectl expose deployment hello-world-rest-api --type=LoadBalancer --port=8080
kubectl scale deployment hello-world-rest-api --replicas=3
kubectl delete pod hello-world-rest-api-58ff5dd898-62l9d
kubectl autoscale deployment hello-world-rest-api --max=10 --cpu-percent=70
kubectl edit deployment hello-world-rest-api #minReadySeconds: 15
kubectl set image deployment hello-world-rest-api hello-world-rest-api=in28min/hello-world-rest-api:0.0.2.RELEASE

gcloud container clusters get-credentials in28minutes-cluster --zone us-central1-a --project solid-course-258105
kubectl create deployment hello-world-rest-api --image=in28min/hello-world-rest-api:0.0.1.RELEASE
kubectl expose deployment hello-world-rest-api --type=LoadBalancer --port=8080
kubectl set image deployment hello-world-rest-api hello-world-rest-api=DUMMY_IMAGE:TEST
kubectl get events --sort-by=.metadata.creationTimestamp
kubectl set image deployment hello-world-rest-api hello-world-rest-api=in28min/hello-world-rest-api:0.0.2.RELEASE
kubectl get events --sort-by=.metadata.creationTimestamp
kubectl get componentstatuses
kubectl get pods --all-namespaces

kubectl get events
kubectl get pods
kubectl get replicaset
kubectl get deployment
kubectl get service

kubectl get pods -o wide

kubectl explain pods
kubectl get pods -o wide

kubectl describe pod hello-world-rest-api-58ff5dd898-9trh2

kubectl get replicasets
kubectl get replicaset

kubectl scale deployment hello-world-rest-api --replicas=3
kubectl get pods
kubectl get replicaset
kubectl get events
kubectl get events --sort.by=.metadata.creationTimestamp

kubectl get rs
kubectl get rs -o wide
kubectl set image deployment hello-world-rest-api hello-world-rest-api=DUMMY_IMAGE:TEST
kubectl get rs -o wide
kubectl get pods
kubectl describe pod hello-world-rest-api-85995ddd5c-msjsm
kubectl get events --sort-by=.metadata.creationTimestamp

kubectl set image deployment hello-world-rest-api hello-world-rest-api=in28min/hello-world-rest-api:0.0.2.RELEASE
kubectl get events --sort-by=.metadata.creationTimestamp
kubectl get pods -o wide
kubectl delete pod hello-world-rest-api-67c79fd44f-n6c7l
kubectl get pods -o wide
kubectl delete pod hello-world-rest-api-67c79fd44f-8bhdt

kubectl get componentstatuses
kubectl get pods --all-namespaces

gcloud auth login
kubectl version
gcloud container clusters get-credentials in28minutes-cluster --zone us-central1-a --project solid-course-258105

kubectl rollout history deployment hello-world-rest-api
kubectl set image deployment hello-world-rest-api hello-world-rest-api=in28min/hello-world-rest-api:0.0.3.RELEASE --record=true
kubectl rollout undo deployment hello-world-rest-api --to-revision=1

kubectl logs hello-world-rest-api-58ff5dd898-6ctr2
kubectl logs -f hello-world-rest-api-58ff5dd898-6ctr2

kubectl get deployment hello-world-rest-api -o yaml
kubectl get deployment hello-world-rest-api -o yaml > deployment.yaml
kubectl get service hello-world-rest-api -o yaml > service.yaml
kubectl apply -f deployment.yaml
kubectl get all -o wide
kubectl delete all -l app=hello-world-rest-api

kubectl get svc --watch
kubectl diff -f deployment.yaml
kubectl delete deployment hello-world-rest-api
kubectl get all -o wide
kubectl delete replicaset.apps/hello-world-rest-api-797dd4b5dc

kubectl get pods --all-namespaces
kubectl get pods --all-namespaces -l app=hello-world-rest-api
kubectl get services --all-namespaces
kubectl get services --all-namespaces --sort-by=.spec.type
kubectl get services --all-namespaces --sort-by=.metadata.name
kubectl cluster-info
kubectl cluster-info dump
kubectl top node
kubectl top pod
kubectl get services
kubectl get svc
kubectl get ev
kubectl get rs
kubectl get ns
kubectl get nodes
kubectl get no
kubectl get pods
kubectl get po

kubectl delete all -l app=hello-world-rest-api
kubectl get all

kubectl apply -f deployment.yaml 
kubectl apply -f ../currency-conversion/deployment.yaml 
```
